#!/bin/bash

exec 2>>/tmp/debug.log

timeout=0.05
blinks=5

led_on()  { xset led named "Scroll Lock" ; }
led_off() { xset -led named "Scroll Lock" ; }
lock()    { exec 200<$0 ; flock 200 || exit 1 ; }
unlock()  { flock -u 200 ; }

action="$1"
data="$2"
from="$3"

if [[ "$action" == "MSG" && "$data" == "IN" ]]; then
    if [[ "$from" == "slack.com" ]]; then
        exit
    fi

    action="UNREAD"
    data="_ _ _ 1"
fi

if [ "$action" == "UNREAD" ]; then
    printf "%q\n" "$@" >&2

    count="$(cut -d' ' -f4 <<< "$data")"
    if [ ${count%% *} -gt 0 ]; then
        lock
        for i in `seq 1 $blinks`; do
            led_on  ; sleep $timeout
            led_off ; sleep $timeout
        done
        led_on
        unlock

        #dbus-launch --exit-with-session \
            notify-send -u critical -t 10000 "mcabber" "new message"
    else
        lock
        led_off
        unlock
    fi
fi
