#!/bin/bash

if [ "$1" = "-v" ]; then
    verbose=1
else
    verbose=
fi

export XAUTHORITY=/home/s.seletskiy/.Xauthority
export DISPLAY=${DISPLAY:-:0.0}

xset r rate 100 140

if [ "$DOTFILES_PROFILE" == "laptop" ]; then
    xset r rate 120 130
fi

if ! sudo footswitch -1 -k f8 -2 -k f7 -3 -k f6; then
    sudo killall -q shift-shift
    sudo -E shift-shift &
fi

setxkbmap \
    -keycodes \
        "evdev+aliases(qwerty)" \
    -symbols $(echo \
        "pc+us+ru:2"`             # common layout settings`\
        "level3(lwin_switch)"`    # use win as lvl3 modifier`\
        "mod4-lvl3"`              # use lvl3 as mod4`\
        "hjkl"`                   # map mod3+hjkl to arrow keys`\
        "hjkl(caret)"`            # mod3+u-]: home/end/insert/delete/pgup/pkdown`\
        "hjkl(rctrl-rshift)"`     # remap right ctrl to right shift`\
        "hjkl(fast-enter)"`       # mod3+m -> enter`\
        "hjkl(fast-escape)"`      # mod3+n -> escape`\
        "terminate(ctrl_alt_bksp)`# terminate X on ctrl+alt+bs`"\
        "capslock(swapescape)"`   # use capslock as esc`\
        "altwin(swap_alt_win)"`   # swap alt and win`\
        "hjkl(fast-numpad)"`      # 1234qwerdf -> 1234567890`\
        "level5(ralt_switch)"`    # right-alt acts as level5 switch \(fast-numpad\)`\
        "level5-menu"`            # use menu for level5 switch as well`\
        "ctrl-shift-caps"`        # remap ctrl/shift/caps` \
        "footswitch(f8-second-layout)"` # pedal for switching language layout `\
        "footswitch(f7-multi-key)"`     # pedal for compose key`\
        | sed 's/ /+/g') \
    -compat \
        "complete+hjkl" \
    -print | (
        if [ "$verbose" ]; then
            xkbcomp - :0
        else
            xkbcomp - :0 &>/dev/null
        fi
    )
