#!/bin/bash

[ -n "$_LOCK" ] || _LOCK=x exec flock -n $0 $0 "$@"

:main() {
    text=()

    text=("$(:template \
        "TIME" \
        "$(:date "LOC" && echo -n '      ')" \
        "$(TZ=America/Los_Angeles :date "PST" && echo -n '      ')" \
        "$(TZ=UTC :date "UTC")" \
    )" "${text[@]}")

    #local loadavg=$(cut -f1 -d' ' /proc/loadavg)
    local temperature=$(
        sensors -u \
            | grep -oP 'temp\d+_input: \K\w+' \
            | sort -rn \
            | head -n1
    )

    local urgency=normal
    if (( $temperature > 80 )); then
        urgency=critical
    fi

    local memory=$(
        printf "%1.1f" \
            $(bc <<< "scale=1; $(free -mt | awk '/Total/ { print $4 }') / 1024")
    )

    local upwork=$(ps -C upwork -o s=)
    if [[ "$upwork" ]]; then
        upwork=" | $(
            grep -qF T <<< "$upwork" && echo "■" || echo "▶"
        )"
    fi

    if (( $(bc <<< "$memory < 0.4") )); then
        memory=$(:urgency "critical" "${memory}G")
    else
        memory=${memory}G
    fi

    text=("$(:template \
        "STAT" \
        $(:urgency "$urgency" "${temperature}°C") \
        "| ${memory}$upwork"
    )" "${text[@]}")

    local acpi=$(acpi -b)
    local battery=$(
        cut -d' ' -f4,5 <<< "$acpi" \
            | tr -d , \
            | awk '{print $2" "$1}'

    )
    if grep -qiF "full" <<< "$acpi"; then
        battery="FULL"
    fi

    local charging="↑"
    if grep -qi "discharging" <<< "$acpi"; then
        charging="↓"
    fi

    local urgency=normal
    if grep -qP '\W(1\d|\d)%' <<< "$battery"; then
        urgency=critical
    fi

    text=("$(:template \
        "BTRY" \
        $(:urgency "$urgency" "${battery} ${charging}")
    )" "${text[@]}")

    local ssid=$(iw dev | grep -Po 'ssid \K.*')

    text=("$(:template \
        "WIFI" \
        ${ssid:-NONE}
    )" "${text[@]}")


    :notify:send "${text[@]}"

    local ping
    local urgency=normal
    if ! ping=$(ping8); then
        urgency=critical
    fi



    text=("$(:template \
        "PING" \
        $(:urgency "$urgency" "$ping")
    )" "${text[@]}")

    :notify:send "${text[@]}"

    local ip

    local urgency=normal
    if ! ip=$(myip); then
        urgency=critical
    fi

    text=("$(:template \
        "INET" \
        $(:urgency "$urgency" "$(myip)")
    )" "${text[@]}")

    :notify:send "${text[@]}"
}

:date() {
    date +"[$1] %T %d/%m/%y %a" \
        | tr '[[:lower:]]' '[[:upper:]]'
}

:template() {
    printf "<b>%s » </b>%s" "$1" "${*:2}"
}

:urgency() {
    local urgency=$1
    if [[ "$urgency" == "critical" ]]; then
        printf '<span background="#ff8c00" foreground="#8b0000"><b> %s </b></span>' \
            "${*:2}"
    else
        printf "%s" "${*:2}"
    fi
}

:notify:send() {
    local IFS=$'\n'
    notify-replace "environment-info" "" "$*"
}

:main "$@"
