#!/bin/bash

:main() {
    :notify:send \
        "normal" \
        "TIME" \
        "$(:date "LOC" && echo -n '      ')" \
        "$(TZ=America/Los_Angeles :date "PST" && echo -n '      ')" \
        "$(TZ=UTC :date "UTC")"

    local loadavg=$(cut -f1 -d' ' /proc/loadavg)
    local temperature=$(
        sensors -u \
            | grep -oP 'temp\d+_input: \K\w+' \
            | sort -rn \
            | head -n1
    )
    local urgency=normal
    if [[ "$temperature" > "80" ]]; then
        urgency=critical
    fi

    local memory=$(free -mt | awk '/Total/ { print $4 }')

    :notify:send "$urgency" "TEMP" \
        "${temperature}C | <b>LA</b> $loadavg | <b>RAM</b> ${memory}MiB"

    local acpi=$(acpi -b)
    local battery=$(
        cut -d' ' -f4,5 <<< "$acpi" \
            | tr -d , \
            | awk '{print $2" "$1}'

    )
    if grep -qiF "full" <<< "$acpi"; then
        battery="FULL"
    fi

    local charging="↑"
    if grep -qi "discharging" <<< "$acpi"; then
        charging="↓"
    fi

    local urgency=normal
    if grep -qP '\W(1\d|\d)%' <<< "$battery"; then
        urgency=critical
    fi

    :notify:send "$urgency" "BTRY" "${battery} ${charging}"

    local urgency=normal

    local ssid=$(iw dev | grep -Po 'ssid \K.*')

    :notify:send "$urgency" "WIFI" "${ssid:-NONE}"

    local ip=$(myip)
    local ping_target=8.8.8.8

    local ping=$(ping -c 1 $ping_target 2>/dev/null | grep -oP 'time=\K\d+')

    :notify:send "$urgency" "INET" "$ip"$'\n'"       ${ping:-??}ms -> $ping_target"
}

:date() {
    date +"[$1] %T %d/%m/%y %a" \
        | tr '[[:lower:]]' '[[:upper:]]'
}

:notify:send() {
    notify-replace "$2" -u "$1" "environment" "<b>$2 » </b>${*:3}"
}

:main "$@"
