#!/bin/bash

if [ "$1" = "-d" ]; then
    dry=1
else
    dry=
fi

if [ "$1" = "-v" ]; then
    verbose=1
else
    verbose=
fi

export XAUTHORITY=/home/operator/.Xauthority
export DISPLAY=${DISPLAY:-:0}

sudo -E pkill shift-shift
sudo -E shift-shift -match "razer|USB KB|USB-HID|keyboard" -first CAPSLOCK -scan-once &

if [[ $(lsusb -v  2>&- | grep -c 'bInterfaceProtocol.*Keyboard') == 2 ]]; then
    xset r rate 130 130
else
    xset r rate 130 110
fi

# QWERTY
#  q w e r t y u i o p
#    a s d f g h j k l
#      z x c v b n m

# RQ
#  q w e r t y u i o p
#    a s h f g d j k l
#      z x c v b n m

symbols=(
    "pc+us+ru:2"             # common layout settings
    "level3(lwin_switch)"    # use win as lvl3 modifier
    "mod4-lvl3"              # use lvl3 as mod4
    "hjkl"                   # map mod3+hjkl to arrow keys
    "hjkl(caret)"            # mod3+u-]: home/end/insert/delete/pgup/pkdown
    "hjkl(fast-enter)"       # mod3+m -> enter
    "altwin(swap_lalt_lwin)" # swap alt and win
    "hjkl(fast-numpad)"      # 1234qwerdf -> 1234567890
    "ctrl-shift-caps"        # remap ctrl/shift/caps
    "rshift-ralt"            # swap rshift and ralt
    "esc-to-execute"         # esc to lock screen
    "fast-copy-paste"        # alt+c -> ctrl+c, alt+v -> shift+ins
    "multi-key"              # enable compose key
    "rq"                     # reconquest layout (incremental)
)

setxkbmap \
    -I ~/.config/xkb/ \
    -keycodes \
        "evdev+aliases(qwerty)+hjkl" \
    -symbols $(
        printf "%s\n" "${symbols[@]}" | paste -sd+
    ) \
    -compat \
        "allow-control-leds+complete+fast-copy-paste+hjkl" \
    -print | (
        if [[ "$dry" ]]; then
            xkbcomp -xkb - -
        else
            if [ "$verbose" ]; then
                xkbcomp - $DISPLAY
            else
                xkbcomp - $DISPLAY &>/dev/null
            fi
        fi
    )
