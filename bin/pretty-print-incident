#!/bin/bash

function :main() {
    local user
    local pass
    local url
    local auth
    local config_path

    config_path=~/.config/pretty-print-incident.rc

    if [ "$1" == "-h" -o "$1" == "--help" ]; then
        cat <<HELP
Usage:

    pretty-print-incident [<url>]

Also, config file $config_path can be created with contents:

    user=<your-confluence-username>
    pass=<your-confluence-password>

If no config file exists, current username $USER will be used and password
will be read interactively.

If no <url> is specified, then clipboard contents will be used.
HELP

        exit 1
    fi

    url=$1
    if [ ! "$url" ]; then
        url=$(xsel -o)
        if grep -vq '^http://' <<< $url; then
            url=""
        fi
    fi

    if [ ! "$url" ]; then
        echo "Please, specify URL as first argument or copy it to clipboard."
        exit 1
    fi


    user=$USER

    if ! source $config_path; then
        cat <<HELP
Please, create $config_path with contents:

user=<your-confluence-username>
pass=<your-confluence-password>

HELP
    fi

    if [ ! "$pass" ]; then
        read -s -p'Password: ' pass
        echo
    fi

    auth="Basic $(printf "%s" $user:$pass | base64)"

    curl -s -XGET -H"Authorization: $auth" $url \
        | lynx -stdin -dump -hiddenlinks=ignore -force_html -list_inline -minimal \
        | awk '/^Период/,/^\s+set_title/' \
        | head -n-1
}

:main "${@}"
